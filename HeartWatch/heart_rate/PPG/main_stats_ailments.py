
from ppg_hr import *
from custom_modules import *
import datetime
import time
import json
import pandas as pd
pd.set_option('display.max_rows', None)
pd.set_option('display.max_columns', None)

def ailments_stats(ppg_list):

    strike = 0
    strike_tachy = 0
    strike_afib = 0
    count = 20
    count_afib = 10
    brady_in= False
    tachy_in = False
    afib_in = False
    data_valid = True
    ppg_bytes = []
    time_val = []
    # reading of the input file starts here
    for ind in range(len(ppg_list)):
        a = ppg_list[ind]
        ppg_data = json.loads(a)
        ppg_sec = ppg_data['data']
        time_val.append(ppg_data['app_date'].split()[1])
        for j in range(2, len(ppg_sec), 3):
            ppg_bytes.append(decimal_to_binary(ppg_sec[j + 1]) + decimal_to_binary(ppg_sec[j]))
    ppg_sig = []
    for i in range(len(ppg_bytes)):
        ppg_sig.append(as_signed_big(ppg_bytes[i]))
    ppg_sig = np.asarray(ppg_sig)

    time_step_v = []
    for i in range(len(time_val)):

        x = time.strptime(time_val[i].split(',')[0], '%H:%M:%S')
        time_step_v.append(datetime.timedelta(hours=x.tm_hour, minutes=x.tm_min, seconds=x.tm_sec).total_seconds())

        if len(time_step_v) > 2:
            if time_step_v[-2] - time_step_v[-1] > 120:
                data_valid = False
    if data_valid:
        final_pr, ppg_21, ppg_sig, ppg_bpf, t_diff_afib, hr_extracted = ppg_plot_hr(ppg_sig, time_val)

        for i in range(len(hr_extracted)):
            if 60 > hr_extracted[i] >= 40:
                strike += 1
            else:
                strike = 0

            if strike == count:
                # print('Patient has Sinus Bradycardia')
                brady_in = True

                # One API call for Bradycardia

            if 100 < hr_extracted[i] <= 130:
                strike_tachy += 1
            else:
                strike_tachy = 0

            if strike_tachy == count:
                # print('Patient has Sinus Tachycardia')
                tachy_in = True

                # One API call for Tachycardia

        for i in range(len(t_diff_afib) - 1):
            if t_diff_afib[i + 1] - t_diff_afib[i] > 10:
                strike_afib += 1
            else:
                strike_afib = 0
            if strike_afib == count_afib:
                # print('Patient has Atrial Fibrillation')
                afib_in = True

        # One API call for Atrial Fibrillation

        res = {'Last time': time_val[-1],'Extracted HR' : hr_extracted,'RR peak intervals':t_diff_afib,'A Fib': afib_in, 'Tachycardia':tachy_in, 'Bradycardia': brady_in }

        # return ppg_sig, hr_extracted, final_pr, afib_in, tachy_in, brady_in, data_valid
        return res
    else:
        statement = 'Data missing for over 2 minutes , PPG analysis not done'
        return statement


# save ppg_sig, hr_extracted, final_pr, afib, tachy, brady, data_valid

result = ailments_stats(['{"_id": "605452ebe6794b000413a860", "data": [-7, 0, -64, 79, 1, -67, 79, 2, -67, 79, 3, -70, 79, 4, -72, 79, 5, -72, 79, 6, -75, 79, 7, -76, 79, 8, -77, 79, 9, -75, 79, 10, -77, 79, 11, -90, 79, 12, -102, 79, 13, -111, 79, 14, -117, 79, 15, -125, 79, 16, 127, 79, 17, 121, 79, 18, 113, 79, 19, 107, 79, 20, 100, 79, 21, 95, 79, 22, 92, 79, 23, 89, 79, 24, 86, -10 ], "app_date": "28/10/2021 16:04:54"}',
                         '{"_id": "605452ebe6794b000413a860", "data": [-7, 0, -64, 79, 1, -67, 79, 2, -67, 79, 3, -70, 79, 4, -72, 79, 5, -72, 79, 6, -75, 79, 7, -76, 79, 8, -77, 79, 9, -75, 79, 10, -77, 79, 11, -90, 79, 12, -102, 79, 13, -111, 79, 14, -117, 79, 15, -125, 79, 16, 127, 79, 17, 121, 79, 18, 113, 79, 19, 107, 79, 20, 100, 79, 21, 95, 79, 22, 92, 79, 23, 89, 79, 24, 86, -10], "app_date": "28/10/2021 16:04:55"}',
                         '{"_id": "605452ebe6794b000413a860", "data": [-7, 0, -64, 79, 1, -67, 79, 2, -67, 79, 3, -70, 79, 4, -72, 79, 5, -72, 79, 6, -75, 79, 7, -76, 79, 8, -77, 79, 9, -75, 79, 10, -77, 79, 11, -90, 79, 12, -102, 79, 13, -111, 79, 14, -117, 79, 15, -125, 79, 16, 127, 79, 17, 121, 79, 18, 113, 79, 19, 107, 79, 20, 100, 79, 21, 95, 79, 22, 92, 79, 23, 89, 79, 24, 86, -10], "app_date": "28/10/2021 16:04:55"}',
                         '{"_id": "605452ebe6794b000413a860", "data": [-7, 0, -64, 79, 1, -67, 79, 2, -67, 79, 3, -70, 79, 4, -72, 79, 5, -72, 79, 6, -75, 79, 7, -76, 79, 8, -77, 79, 9, -75, 79, 10, -77, 79, 11, -90, 79, 12, -102, 79, 13, -111, 79, 14, -117, 79, 15, -125, 79, 16, 127, 79, 17, 121, 79, 18, 113, 79, 19, 107, 79, 20, 100, 79, 21, 95, 79, 22, 92, 79, 23, 89, 79, 24, 86, -10], "app_date": "28/10/2021 16:04:55"}',
                         '{"_id": "605452ebe6794b000413a860", "data": [-7, 0, -64, 79, 1, -67, 79, 2, -67, 79, 3, -70, 79, 4, -72, 79, 5, -72, 79, 6, -75, 79, 7, -76, 79, 8, -77, 79, 9, -75, 79, 10, -77, 79, 11, -90, 79, 12, -102, 79, 13, -111, 79, 14, -117, 79, 15, -125, 79, 16, 127, 79, 17, 121, 79, 18, 113, 79, 19, 107, 79, 20, 100, 79, 21, 95, 79, 22, 92, 79, 23, 89, 79, 24, 86, -10], "app_date": "28/10/2021 16:04:55"}',
                         '{"_id": "605452ebe6794b000413a860", "data": [-7, 0, -64, 79, 1, -67, 79, 2, -67, 79, 3, -70, 79, 4, -72, 79, 5, -72, 79, 6, -75, 79, 7, -76, 79, 8, -77, 79, 9, -75, 79, 10, -77, 79, 11, -90, 79, 12, -102, 79, 13, -111, 79, 14, -117, 79, 15, -125, 79, 16, 127, 79, 17, 121, 79, 18, 113, 79, 19, 107, 79, 20, 100, 79, 21, 95, 79, 22, 92, 79, 23, 89, 79, 24, 86, -10], "app_date": "28/10/2021 16:04:55"}',
                         '{"_id": "605452ebe6794b000413a860", "data": [-7, 0, -64, 79, 1, -67, 79, 2, -67, 79, 3, -70, 79, 4, -72, 79, 5, -72, 79, 6, -75, 79, 7, -76, 79, 8, -77, 79, 9, -75, 79, 10, -77, 79, 11, -90, 79, 12, -102, 79, 13, -111, 79, 14, -117, 79, 15, -125, 79, 16, 127, 79, 17, 121, 79, 18, 113, 79, 19, 107, 79, 20, 100, 79, 21, 95, 79, 22, 92, 79, 23, 89, 79, 24, 86, -10], "app_date": "28/10/2021 16:04:55"}',
                         '{"_id": "605452ebe6794b000413a860", "data": [-7, 0, -64, 79, 1, -67, 79, 2, -67, 79, 3, -70, 79, 4, -72, 79, 5, -72, 79, 6, -75, 79, 7, -76, 79, 8, -77, 79, 9, -75, 79, 10, -77, 79, 11, -90, 79, 12, -102, 79, 13, -111, 79, 14, -117, 79, 15, -125, 79, 16, 127, 79, 17, 121, 79, 18, 113, 79, 19, 107, 79, 20, 100, 79, 21, 95, 79, 22, 92, 79, 23, 89, 79, 24, 86, -10], "app_date": "28/10/2021 16:04:55"}',
                         '{"_id": "605452ebe6794b000413a860", "data": [-7, 0, -64, 79, 1, -67, 79, 2, -67, 79, 3, -70, 79, 4, -72, 79, 5, -72, 79, 6, -75, 79, 7, -76, 79, 8, -77, 79, 9, -75, 79, 10, -77, 79, 11, -90, 79, 12, -102, 79, 13, -111, 79, 14, -117, 79, 15, -125, 79, 16, 127, 79, 17, 121, 79, 18, 113, 79, 19, 107, 79, 20, 100, 79, 21, 95, 79, 22, 92, 79, 23, 89, 79, 24, 86, -10], "app_date": "28/10/2021 16:04:55"}',
                         '{"_id": "605452ebe6794b000413a860", "data": [-7, 0, -64, 79, 1, -67, 79, 2, -67, 79, 3, -70, 79, 4, -72, 79, 5, -72, 79, 6, -75, 79, 7, -76, 79, 8, -77, 79, 9, -75, 79, 10, -77, 79, 11, -90, 79, 12, -102, 79, 13, -111, 79, 14, -117, 79, 15, -125, 79, 16, 127, 79, 17, 121, 79, 18, 113, 79, 19, 107, 79, 20, 100, 79, 21, 95, 79, 22, 92, 79, 23, 89, 79, 24, 86, -10], "app_date": "28/10/2021 16:04:55"}',
                         '{"_id": "605452ebe6794b000413a860", "data": [-7, 0, -64, 79, 1, -67, 79, 2, -67, 79, 3, -70, 79, 4, -72, 79, 5, -72, 79, 6, -75, 79, 7, -76, 79, 8, -77, 79, 9, -75, 79, 10, -77, 79, 11, -90, 79, 12, -102, 79, 13, -111, 79, 14, -117, 79, 15, -125, 79, 16, 127, 79, 17, 121, 79, 18, 113, 79, 19, 107, 79, 20, 100, 79, 21, 95, 79, 22, 92, 79, 23, 89, 79, 24, 86, -10], "app_date": "28/10/2021 16:04:55"}',
                         '{"_id": "605452ebe6794b000413a860", "data": [-7, 0, -64, 79, 1, -67, 79, 2, -67, 79, 3, -70, 79, 4, -72, 79, 5, -72, 79, 6, -75, 79, 7, -76, 79, 8, -77, 79, 9, -75, 79, 10, -77, 79, 11, -90, 79, 12, -102, 79, 13, -111, 79, 14, -117, 79, 15, -125, 79, 16, 127, 79, 17, 121, 79, 18, 113, 79, 19, 107, 79, 20, 100, 79, 21, 95, 79, 22, 92, 79, 23, 89, 79, 24, 86, -10], "app_date": "28/10/2021 16:04:55"}',
                         '{"_id": "605452ebe6794b000413a860", "data": [-7, 0, -64, 79, 1, -67, 79, 2, -67, 79, 3, -70, 79, 4, -72, 79, 5, -72, 79, 6, -75, 79, 7, -76, 79, 8, -77, 79, 9, -75, 79, 10, -77, 79, 11, -90, 79, 12, -102, 79, 13, -111, 79, 14, -117, 79, 15, -125, 79, 16, 127, 79, 17, 121, 79, 18, 113, 79, 19, 107, 79, 20, 100, 79, 21, 95, 79, 22, 92, 79, 23, 89, 79, 24, 86, -10], "app_date": "28/10/2021 16:04:55"}',
                         '{"_id": "605452ebe6794b000413a860", "data": [-7, 0, -64, 79, 1, -67, 79, 2, -67, 79, 3, -70, 79, 4, -72, 79, 5, -72, 79, 6, -75, 79, 7, -76, 79, 8, -77, 79, 9, -75, 79, 10, -77, 79, 11, -90, 79, 12, -102, 79, 13, -111, 79, 14, -117, 79, 15, -125, 79, 16, 127, 79, 17, 121, 79, 18, 113, 79, 19, 107, 79, 20, 100, 79, 21, 95, 79, 22, 92, 79, 23, 89, 79, 24, 86, -10], "app_date": "28/10/2021 16:04:55"}',
                         '{"_id": "605452ebe6794b000413a860", "data": [-7, 0, -64, 79, 1, -67, 79, 2, -67, 79, 3, -70, 79, 4, -72, 79, 5, -72, 79, 6, -75, 79, 7, -76, 79, 8, -77, 79, 9, -75, 79, 10, -77, 79, 11, -90, 79, 12, -102, 79, 13, -111, 79, 14, -117, 79, 15, -125, 79, 16, 127, 79, 17, 121, 79, 18, 113, 79, 19, 107, 79, 20, 100, 79, 21, 95, 79, 22, 92, 79, 23, 89, 79, 24, 86, -10], "app_date": "28/10/2021 16:04:55"}',
                         '{"_id": "605452ebe6794b000413a860", "data": [-7, 0, -64, 79, 1, -67, 79, 2, -67, 79, 3, -70, 79, 4, -72, 79, 5, -72, 79, 6, -75, 79, 7, -76, 79, 8, -77, 79, 9, -75, 79, 10, -77, 79, 11, -90, 79, 12, -102, 79, 13, -111, 79, 14, -117, 79, 15, -125, 79, 16, 127, 79, 17, 121, 79, 18, 113, 79, 19, 107, 79, 20, 100, 79, 21, 95, 79, 22, 92, 79, 23, 89, 79, 24, 86, -10], "app_date": "28/10/2021 16:04:55"}',
                         '{"_id": "605452ebe6794b000413a860", "data": [-7, 0, -64, 79, 1, -67, 79, 2, -67, 79, 3, -70, 79, 4, -72, 79, 5, -72, 79, 6, -75, 79, 7, -76, 79, 8, -77, 79, 9, -75, 79, 10, -77, 79, 11, -90, 79, 12, -102, 79, 13, -111, 79, 14, -117, 79, 15, -125, 79, 16, 127, 79, 17, 121, 79, 18, 113, 79, 19, 107, 79, 20, 100, 79, 21, 95, 79, 22, 92, 79, 23, 89, 79, 24, 86, -10], "app_date": "28/10/2021 16:04:55"}',
                         '{"_id": "605452ebe6794b000413a860", "data": [-7, 0, -64, 79, 1, -67, 79, 2, -67, 79, 3, -70, 79, 4, -72, 79, 5, -72, 79, 6, -75, 79, 7, -76, 79, 8, -77, 79, 9, -75, 79, 10, -77, 79, 11, -90, 79, 12, -102, 79, 13, -111, 79, 14, -117, 79, 15, -125, 79, 16, 127, 79, 17, 121, 79, 18, 113, 79, 19, 107, 79, 20, 100, 79, 21, 95, 79, 22, 92, 79, 23, 89, 79, 24, 86, -10], "app_date": "28/10/2021 16:04:55"}',
                         '{"_id": "605452ebe6794b000413a860", "data": [-7, 0, -64, 79, 1, -67, 79, 2, -67, 79, 3, -70, 79, 4, -72, 79, 5, -72, 79, 6, -75, 79, 7, -76, 79, 8, -77, 79, 9, -75, 79, 10, -77, 79, 11, -90, 79, 12, -102, 79, 13, -111, 79, 14, -117, 79, 15, -125, 79, 16, 127, 79, 17, 121, 79, 18, 113, 79, 19, 107, 79, 20, 100, 79, 21, 95, 79, 22, 92, 79, 23, 89, 79, 24, 86, -10], "app_date": "28/10/2021 16:04:55"}',
                         '{"_id": "605452ebe6794b000413a860", "data": [-7, 0, -64, 79, 1, -67, 79, 2, -67, 79, 3, -70, 79, 4, -72, 79, 5, -72, 79, 6, -75, 79, 7, -76, 79, 8, -77, 79, 9, -75, 79, 10, -77, 79, 11, -90, 79, 12, -102, 79, 13, -111, 79, 14, -117, 79, 15, -125, 79, 16, 127, 79, 17, 121, 79, 18, 113, 79, 19, 107, 79, 20, 100, 79, 21, 95, 79, 22, 92, 79, 23, 89, 79, 24, 86, -10], "app_date": "28/10/2021 16:04:55"}',
                         '{"_id": "605452ebe6794b000413a860", "data": [-7, 0, -64, 79, 1, -67, 79, 2, -67, 79, 3, -70, 79, 4, -72, 79, 5, -72, 79, 6, -75, 79, 7, -76, 79, 8, -77, 79, 9, -75, 79, 10, -77, 79, 11, -90, 79, 12, -102, 79, 13, -111, 79, 14, -117, 79, 15, -125, 79, 16, 127, 79, 17, 121, 79, 18, 113, 79, 19, 107, 79, 20, 100, 79, 21, 95, 79, 22, 92, 79, 23, 89, 79, 24, 86, -10], "app_date": "28/10/2021 16:04:55"}',
                         '{"_id": "605452ebe6794b000413a860", "data": [-7, 0, -64, 79, 1, -67, 79, 2, -67, 79, 3, -70, 79, 4, -72, 79, 5, -72, 79, 6, -75, 79, 7, -76, 79, 8, -77, 79, 9, -75, 79, 10, -77, 79, 11, -90, 79, 12, -102, 79, 13, -111, 79, 14, -117, 79, 15, -125, 79, 16, 127, 79, 17, 121, 79, 18, 113, 79, 19, 107, 79, 20, 100, 79, 21, 95, 79, 22, 92, 79, 23, 89, 79, 24, 86, -10], "app_date": "28/10/2021 16:04:55"}',
                         '{"_id": "605452ebe6794b000413a860", "data": [-7, 0, -64, 79, 1, -67, 79, 2, -67, 79, 3, -70, 79, 4, -72, 79, 5, -72, 79, 6, -75, 79, 7, -76, 79, 8, -77, 79, 9, -75, 79, 10, -77, 79, 11, -90, 79, 12, -102, 79, 13, -111, 79, 14, -117, 79, 15, -125, 79, 16, 127, 79, 17, 121, 79, 18, 113, 79, 19, 107, 79, 20, 100, 79, 21, 95, 79, 22, 92, 79, 23, 89, 79, 24, 86, -10], "app_date": "28/10/2021 16:04:55"}',
                         '{"_id": "605452ebe6794b000413a860", "data": [-7, 0, -64, 79, 1, -67, 79, 2, -67, 79, 3, -70, 79, 4, -72, 79, 5, -72, 79, 6, -75, 79, 7, -76, 79, 8, -77, 79, 9, -75, 79, 10, -77, 79, 11, -90, 79, 12, -102, 79, 13, -111, 79, 14, -117, 79, 15, -125, 79, 16, 127, 79, 17, 121, 79, 18, 113, 79, 19, 107, 79, 20, 100, 79, 21, 95, 79, 22, 92, 79, 23, 89, 79, 24, 86, -10], "app_date": "28/10/2021 16:04:55"}',
                         '{"_id": "605452ebe6794b000413a860", "data": [-7, 0, -64, 79, 1, -67, 79, 2, -67, 79, 3, -70, 79, 4, -72, 79, 5, -72, 79, 6, -75, 79, 7, -76, 79, 8, -77, 79, 9, -75, 79, 10, -77, 79, 11, -90, 79, 12, -102, 79, 13, -111, 79, 14, -117, 79, 15, -125, 79, 16, 127, 79, 17, 121, 79, 18, 113, 79, 19, 107, 79, 20, 100, 79, 21, 95, 79, 22, 92, 79, 23, 89, 79, 24, 86, -10], "app_date": "28/10/2021 16:04:55"}',
                         '{"_id": "605452ebe6794b000413a860", "data": [-7, 0, -64, 79, 1, -67, 79, 2, -67, 79, 3, -70, 79, 4, -72, 79, 5, -72, 79, 6, -75, 79, 7, -76, 79, 8, -77, 79, 9, -75, 79, 10, -77, 79, 11, -90, 79, 12, -102, 79, 13, -111, 79, 14, -117, 79, 15, -125, 79, 16, 127, 79, 17, 121, 79, 18, 113, 79, 19, 107, 79, 20, 100, 79, 21, 95, 79, 22, 92, 79, 23, 89, 79, 24, 86, -10], "app_date": "28/10/2021 16:04:55"}',
                         '{"_id": "605452ebe6794b000413a860", "data": [-7, 0, -64, 79, 1, -67, 79, 2, -67, 79, 3, -70, 79, 4, -72, 79, 5, -72, 79, 6, -75, 79, 7, -76, 79, 8, -77, 79, 9, -75, 79, 10, -77, 79, 11, -90, 79, 12, -102, 79, 13, -111, 79, 14, -117, 79, 15, -125, 79, 16, 127, 79, 17, 121, 79, 18, 113, 79, 19, 107, 79, 20, 100, 79, 21, 95, 79, 22, 92, 79, 23, 89, 79, 24, 86, -10], "app_date": "28/10/2021 16:04:55"}',
                         '{"_id": "605452ebe6794b000413a860", "data": [-7, 0, -64, 79, 1, -67, 79, 2, -67, 79, 3, -70, 79, 4, -72, 79, 5, -72, 79, 6, -75, 79, 7, -76, 79, 8, -77, 79, 9, -75, 79, 10, -77, 79, 11, -90, 79, 12, -102, 79, 13, -111, 79, 14, -117, 79, 15, -125, 79, 16, 127, 79, 17, 121, 79, 18, 113, 79, 19, 107, 79, 20, 100, 79, 21, 95, 79, 22, 92, 79, 23, 89, 79, 24, 86, -10], "app_date": "28/10/2021 16:04:55"}',
                         '{"_id": "605452ebe6794b000413a860", "data": [-7, 0, -64, 79, 1, -67, 79, 2, -67, 79, 3, -70, 79, 4, -72, 79, 5, -72, 79, 6, -75, 79, 7, -76, 79, 8, -77, 79, 9, -75, 79, 10, -77, 79, 11, -90, 79, 12, -102, 79, 13, -111, 79, 14, -117, 79, 15, -125, 79, 16, 127, 79, 17, 121, 79, 18, 113, 79, 19, 107, 79, 20, 100, 79, 21, 95, 79, 22, 92, 79, 23, 89, 79, 24, 86, -10], "app_date": "28/10/2021 16:04:55"}',
                         '{"_id": "605452ebe6794b000413a860", "data": [-7, 0, -64, 79, 1, -67, 79, 2, -67, 79, 3, -70, 79, 4, -72, 79, 5, -72, 79, 6, -75, 79, 7, -76, 79, 8, -77, 79, 9, -75, 79, 10, -77, 79, 11, -90, 79, 12, -102, 79, 13, -111, 79, 14, -117, 79, 15, -125, 79, 16, 127, 79, 17, 121, 79, 18, 113, 79, 19, 107, 79, 20, 100, 79, 21, 95, 79, 22, 92, 79, 23, 89, 79, 24, 86, -10], "app_date": "28/10/2021 16:04:55"}'])

# print(result)